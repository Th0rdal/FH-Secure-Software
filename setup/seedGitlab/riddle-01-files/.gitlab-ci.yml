# Diese Datei liegt in /work/riddle-01-files/.gitlab-ci.yml
# und wird von Ansible kopiert.

stages:
  - trigger_test

trigger_riddle_tester:
  stage: trigger_test
  image: alpine:3.19
  before_script:
    - apk update && apk add curl
  script:
    - |
      echo "Triggering private test pipeline..."

      # --- DEBUGGING TOKEN ---
      echo "Pr체fe Token-Status..."
      # Die gesamte Logik innerhalb des 'pipe' Blocks
      if [ -z "${GITLAB_ADMIN_TOKEN}" ]; then 
        echo "FEHLER: Token ist LEER!"; 
      else 
        echo "Token ist vorhanden."; 
      fi

      echo "Token-L채nge (sollte > 0 sein): $(echo -n ${GITLAB_ADMIN_TOKEN} | wc -c)"
      echo "Token-Wert (zur Kontrolle): '${GITLAB_ADMIN_TOKEN}'"
      echo "--- END DEBUGGING ---"

      # Der eigentliche API-Aufruf:
      # 1. Verwendung der Projekt-ID ${ADMIN_CI_PROJECT_ID} (statt root%2F...)
      # 2. Token in einfachen Anf체hrungszeichen (PRIVATE-TOKEN: '...')

      ADMIN_ID="${ADMIN_CI_PROJECT_ID}"

      API_RESPONSE=$(curl --silent --show-error --write-out "\nHTTP_STATUS:%{http_code}" \
        --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_ADMIN_TOKEN}" \
        --form "ref=main" \
        --form "variables[RIDDLE_PROJECT_PATH]=${CI_PROJECT_PATH}" \
        --form "variables[RIDDLE_COMMIT_SHA]=${CI_COMMIT_SHA}" \
        --form "variables[NEXT_RIDDLE_PATH]=riddle-02" \
        "${CI_SERVER_URL}/api/v4/projects/${ADMIN_ID}/trigger/pipeline") # <-- HIER IST DIE PROJEKT-ID KORREKTUR

      echo "Trigger request sent."
      echo "API Response: ${API_RESPONSE}" # N체tzlich zum Debuggen

  tags:
    - local
